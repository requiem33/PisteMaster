# PisteMaster: 架构与系统设计文档

## 1. 软件最终形态与核心愿景

PisteMaster 将被设计为一个专业的、功能全面的击剑赛事编排与管理平台，它将以两种形态服务于不同场景，并具备强大的协同工作与离线能力。

- **1.1. 双重形态**:
    - **Web 应用**: 面向公众和选手的纯展示端，用于实时查看赛事信息、对阵表和最终排名。
    - **桌面应用**: 面向赛事组织者和工作人员的核心工作平台，支持 Windows、macOS 等主流操作系统。

- **1.2. 分布式协同**:
    - 多个桌面应用客户端可以在同一局域网内组成一个工作集群，协同编排同一场大型比赛。
    - 集群通过 **etcd** 实现服务发现和主节点 (Leader) 动态选举，保证系统的高可用性。

- **1.3. 实时同步**:
    - 桌面端集群的编排结果（如比分、晋级状态）将实时同步至**云端后端**，并由云端推送给所有 Web 应用客户端。

- **1.4. 离线优先**:
    - 桌面应用必须支持**完全离线工作**。所有操作都应获得即时响应，并在网络恢复后，将离线期间产生的数据变更与主节点或云端进行同步。

- **1.5. 权限管理**:
    - 系统将拥有完善的、由云端统一管理的权限控制体系。不同角色的用户（管理员、赛事指定编排者、普通用户）将拥有不同的操作权限。

## 2. 核心架构原则

为了实现上述愿景，我们确立了三大核心架构原则：

- **2.1. 命令查询职责分离 (CQRS)**
    - **命令 (Commands)**: 任何**改变数据**的操作（创建、更新、删除）。在集群模式下，只有**主节点 (Leader)** 有权执行命令。
    - **查询 (Queries)**: 任何**读取数据**的操作（查看列表、渲染UI）。为了极致的性能，所有节点都在**本地**执行查询。

- **2.2. 事件驱动复制 (Event-Driven Replication)**
    - 主节点在成功执行一个“命令”后，会向集群广播一个描述该变更的“事件”。
    - 从节点 (Followers) 监听这些事件，并在自己本地的数据库上“重放”这些变更，从而实现各节点数据的最终一致性。

- **2.3. 乐观 UI (Optimistic UI)**
    - 为了提供零延迟的交互体验，用户的写操作会**立即更新 UI 和本地缓存 (IndexedDB)**，然后**异步地**将“命令”发送到后端。
    - 这确保了即使用户在进行密集的写操作，应用界面依然保持丝滑流畅。失败的命令将被优雅地处理并放入重试队列。

## 3. 系统分层架构

PisteMaster 被划分为三个独立的、职责清晰的层次：

### 3.1. 云端后端 (Cloud Backend)

> **角色**: 系统的绝对权威，所有数据的最终归宿和权限的唯一仲裁者。

- **技术栈**:
    - **框架**: **Django + Django REST Framework (DRF)**
    - **数据库**: **PostgreSQL** (生产环境)
- **职责**:
    - 托管 Web 应用所需的所有 API。
    - 管理用户账户、角色及权限。
    - 存储永久性的赛事数据。
    - 作为桌面端集群数据同步的终点和灾备中心。
    - 托管桌面端打包所需的 `backend.exe` 的下载。

### 3.2. 桌面应用 (Desktop Application)

> **角色**: 赛事编排的核心工作站，一个功能完备、可离线、可集群的“重客户端”。

它由两个紧密协作的部分组成：

- **A. Electron 应用外壳 (`PisteMaster.exe`)**
    - **技术栈**: **Electron + Vue 3**
    - **职责**:
        - **UI 界面 (Renderer Process)**: 运行 Vue 应用，负责所有用户交互。
        - **后台协调器 (Main Process)**:
            - **进程管理器**: 在后台静默启动和管理 `backend.exe` 的生命周期。
            - **网络协调器**: 使用 **etcd** 客户端进行主节点选举和服务发现。
            - **命令代理**: 拦截 UI 发出的“写”请求，如果自身是从节点，则将请求转发给主节点。
            - **事件客户端**: 作为 WebSocket 客户端，接收主节点广播的“事件”并触发本地数据的更新。

- **B. 内嵌 Django 后端 (`backend.exe`)**
    - **技术栈**: **Django + PyInstaller + SQLite**
    - **职责**:
        - **本地 API 服务**: 在 `localhost` 提供一个与云端后端完全兼容的 API。
        - **本地数据源**: 使用 **SQLite** 数据库（一个 `.db` 文件）存储本节点的所有赛事数据。
        - **打包**: 使用 PyInstaller 打包成一个用户无感的、随主程序启动的后台进程。

### 3.3. Web 应用 (Web Application)

> **角色**: 面向公众的、轻量级的纯展示客户端。

- **技术栈**: **Vue 3**
- **职责**:
    - 通过 HTTP 请求与**云端后端**交互，展示赛事信息。
    - （可选）通过 WebSocket 实时接收成绩更新。
    - 无本地持久化存储。

## 4. 下一步：单客户端版本 To-Do List

为了实现上述宏伟蓝图，我们将从开发一个功能完备的“单客户端版本”开始。这是所有后续工作的基础。

**Phase 1: 后端准备与容器化**

- [ ] **1.1. 完善 Django 模型**: 根据 `database_schema.md`，最终确认 `apps/core/models.py` 中的所有模型定义。
- [ ] **1.2. 适配双数据库**:
    - [ ] 修改 `settings.py`，使其能通过环境变量在 PostgreSQL（云端）和 SQLite（桌面端）之间无缝切换。
    - [ ] 确认 Python 环境中的 `sqlite3` 模块版本 >= 3.9.0，以保证 `JSONField` 的兼容性。
- [ ] **1.3. 完善核心 API**: 使用 DRF 确保所有核心业务（创建/获取赛事、更新比分、保存排名）都有稳定可靠的 API 接口。
- [ ] **1.4. (关键任务) 打包 `backend.exe`**:
    - [ ] 安装 `PyInstaller` 和 `waitress` (一个轻量级的生产服务器)。
    - [ ] 编写 `backend.spec` 配置文件，用于指导 PyInstaller 打包。
    - [ ] 反复测试和调试，直到成功生成一个可以在 Windows 上独立运行的 `backend.exe`，该程序启动后应在 `localhost:8000`
      提供服务。

**Phase 2: 前端改造与对接**

- [ ] **2.1. 重构 `DataManager.ts`**:
    - [ ] 将所有 `IndexedDBService` 的直接调用，替换为 `fetch` 或 `axios` HTTP 请求，目标地址为 `http://localhost:8000`。
    - [ ] 确保所有 `GET`、`POST`、`PUT` 请求都能与 `backend.exe` 提供的 API 正常通信。
- [ ] **2.2. 实现“乐观 UI”模式**:
    - [ ] 对于所有**写**操作（如保存比分），重构方法，使其**立即更新 IndexedDB**，然后**异步**发送 API 请求。
    - [ ] 为 API 请求添加错误处理逻辑。如果请求失败，向用户发出提示，并考虑实现一个简单的“重试”机制。

**Phase 3: Electron 集成与最终打包**

- [ ] **3.1. 创建 Electron 项目**:
    - [ ] 初始化一个新的 Electron 项目。
    - [ ] 将我们已经能与 `backend.exe` 通信的 Vue 应用，作为其渲染进程 (UI)。
- [ ] **3.2. (关键任务) 进程管理**:
    - [ ] 在 Electron 的 Main Process 中，编写 Node.js 脚本。
    - [ ] 使用 `child_process.spawn` 在 Electron 应用启动时，静默地、带参数地运行 `backend.exe`。
    - [ ] 监听 `backend.exe` 的 `exit` 事件，在 Electron 应用退出时，确保 `backend.exe` 进程被优雅地关闭。
- [ ] **3.3. 构建与测试**:
    - [ ] 使用 `electron-builder` 将整个应用打包成一个独立的 `PisteMaster-Setup.exe` 安装程序。
    - [ ] 在一台纯净的 Windows 电脑上进行安装和端到端测试，确保无需任何额外依赖即可正常运行。
